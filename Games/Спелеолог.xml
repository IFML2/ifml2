<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<story xmlns="http://toysoft.narod.ru/IFML2Schema" id="spel">
    <!-- todo Добавить в игру
        + "выдернуть лиану"
    -->
    <storyOptions>
        <startLocationOption showStartLocDesc="false" location="Зал"/>
        <startProcedureOption procedure="ПоказатьПредысторию"/>
        <storyDescription author="realsonic" version="0.1 альфа от 05.11.2012" description="Приключения спелеолога в пещере (порт standalone-игры)." name="Спелеолог"/>
        <globalVars>
            <var position="1" name="СрубилЛиану" value="нет"/>
        </globalVars>
    </storyOptions>
    <libraries>
        <library>standard/verbs.xml</library>
    </libraries>
    <dictionary>
        <word>
            <ip>камень</ip>
            <vp>камень</vp>
            <tp>камнем</tp>
        </word>
        <word>
            <ip>кусок</ip>
            <rp>куска</rp>
            <dp>куску</dp>
            <vp>кусок</vp>
            <tp>куском</tp>
            <pp>куске</pp>
        </word>
        <word>
            <ip>верёвка</ip>
            <vp>верёвку</vp>
            <tp>верёвкой</tp>
        </word>
        <word>
            <ip>нож</ip>
            <vp>нож</vp>
            <tp>ножом</tp>
        </word>
        <word>
            <ip>лиана</ip>
            <vp>лиану</vp>
            <tp>лианой</tp>
        </word>
        <word>
            <ip>старая</ip>
            <vp>старую</vp>
            <tp>старой</tp>
        </word>
        <word>
            <ip>спички</ip>
            <vp>спички</vp>
            <tp>спичками</tp>
        </word>
        <word>
            <ip>карманный</ip>
            <vp>карманный</vp>
            <tp>карманным</tp>
        </word>
        <word>
            <ip>фонарик</ip>
            <vp>фонарик</vp>
            <tp>фонариком</tp>
        </word>
        <word>
            <ip>камни</ip>
            <vp>камни</vp>
            <tp>камнями</tp>
        </word>
        <word>
            <ip>динамит</ip>
            <vp>динамит</vp>
            <tp>динамитом</tp>
        </word>
        <word>
            <ip>завал</ip>
            <vp>завал</vp>
            <tp>завалом</tp>
        </word>
        <word>
            <ip>ствол</ip>
            <vp>ствол</vp>
            <tp>стволом</tp>
        </word>
        <word>
            <ip>кирка</ip>
            <vp>кирку</vp>
            <tp>киркой</tp>
        </word>
    </dictionary>
    <locations>
        <location name="Зал" id="Зал">
            <attributes/>
            <description>Узкий луч света прорывается сквозь щель в камнях. Можно видеть только каменое дно и три выхода: на восток, юг и запад.</description>
            <words/>
            <hooks>
                <hook type="instead" action="осмотреться">
                    <instructions>
                        <showMessage position="1" type="text" message="Перекрыто!"/>
                    </instructions>
                </hook>
            </hooks>
            <east>ЗавалЛок</east>
            <south>ЮжныйЗал</south>
            <west>ЗападныйЗал</west>
        </location>
        <location name="Западный зал" id="ЗападныйЗал">
            <attributes/>
            <description>Одна из многочисленных пещерных комнат в этом районе. Проходы на восток и запад.</description>
            <words/>
            <east>Зал</east>
            <west>ШумВоды</west>
        </location>
        <location name="Завал" id="ЗавалЛок">
            <attributes/>
            <description>Ход, заваленый камнем. Отсюда Вы пришли! Пройти можно только на запад.</description>
            <words/>
            <west>Зал</west>
        </location>
        <location name="Южный зал" id="ЮжныйЗал">
            <attributes/>
            <description>Круглый каменый свод нависает над небольшим отверстием, уходящим вниз. Также можно пройти на север.</description>
            <words/>
            <down>СтараяШахта</down>
            <north>Зал</north>
        </location>
        <location name="Старая шахта" id="СтараяШахта">
            <attributes/>
            <description>Перед Вами открывается вид старой и заброшенной шахты. После небольших поисков, полных надежды, обнаруживается, что выход из неё отрезан. На полу и по углам лежат различные старые вещи. Проходы ведут наверх и на юг.</description>
            <words/>
            <south>Штольня</south>
            <up>ЮжныйЗал</up>
        </location>
        <location name="Штольня" id="Штольня">
            <attributes/>
            <description>Старая заброшенная штольня. Среди обломков камней и деревянных креплений стен Вы замечаете и другие вещи. Вернуться можно только на север.</description>
            <words/>
            <north>СтараяШахта</north>
        </location>
        <location name="Шум воды" id="ШумВоды">
            <attributes/>
            <description>Шум воды доносится из соседней комнаты, а в воздухе витают небольшие капли росы.</description>
            <words/>
            <east>ЗападныйЗал</east>
            <west>ПодземнаяРека</west>
        </location>
        <location name="Подземная река" id="ПодземнаяРека">
            <attributes/>
            <description>Здесь течёт подземная река. Она истекает из-под каменной стены и уходит дальше на юг. Нырнуть невозможно: слишком холодно, притом она может не иметь выхода на поверхность.</description>
            <words/>
            <east>ШумВоды</east>
            <south>ПодземноеОзеро</south>
        </location>
        <location name="Подземное озеро" id="ПодземноеОзеро">
            <attributes/>
            <description>Подземная река впадает в подземное озеро. Похоже, оно просачивается снизу под камнями. В одной из стен зияет небольшой проход.</description>
            <words/>
            <east>Растительность</east>
            <north>ПодземнаяРека</north>
        </location>
        <location name="Растительность" id="Растительность">
            <attributes/>
            <description>Пол здесь составляет обычная почва! В потолке виднеется отверстие, из которого падает на пол луч света. По некоторым обстоятельствам видно, что здесь был выход наверх, и солнце было ярче здесь. На земле видны засохшие старые стволы какой-то лианы!</description>
            <words/>
            <west>ПодземноеОзеро</west>
        </location>
    </locations>
    <items>
        <item name="карманный фонарик спелеолога" id="ФонарикПред">
            <attributes/>
            <description>Обычный фонарик.</description>
            <words mainWord="фонарик">
                <word>фонарик</word>
            </words>
            <startingPosition>
                <inventory>true</inventory>
                <locations/>
            </startingPosition>
            <hooks/>
        </item>
        <item name="спички" id="СпичкиПред">
            <attributes/>
            <description>Обычные спички.</description>
            <words mainWord="спички">
                <word>спички</word>
            </words>
            <startingPosition>
                <inventory>true</inventory>
                <locations/>
            </startingPosition>
            <hooks/>
        </item>
        <item name="моток верёвки" id="ВеревкаПред">
            <attributes/>
            <description>Обычная верёвка.</description>
            <words mainWord="верёвка">
                <word>верёвка</word>
            </words>
            <startingPosition>
                <inventory>true</inventory>
                <locations/>
            </startingPosition>
            <hooks/>
        </item>
        <item name="карманный нож" id="НожПред">
            <attributes/>
            <description>Обычный нож.</description>
            <words mainWord="нож">
                <word>нож</word>
            </words>
            <startingPosition>
                <inventory>true</inventory>
                <locations/>
            </startingPosition>
            <hooks>
            </hooks>
        </item>
        <item name="кусок скальной породы" id="КаменьПред">
            <attributes/>
            <description>Этот булыжник валяется здесь повсюду. Он такой же, как и все остальные.</description>
            <words mainWord="кусок">
                <word>кусок</word>
            </words>
            <startingPosition>
                <inventory>false</inventory>
                <locations>
                    <location>ЗападныйЗал</location>
                </locations>
            </startingPosition>
            <hooks/>
        </item>
        <item name="завал камней" id="ЗавалПред">
            <attributes>
                <attribute>частьПейзажа</attribute>
            </attributes>
            <description>Камни слишком тяжелы и их слишком много, чтобы разобрать руками. Небольшой взрыв очень помог бы делу.</description>
            <words mainWord="завал">
                <word>завал</word>
            </words>
            <startingPosition>
                <inventory>false</inventory>
                <locations>
                    <location>ЗавалЛок</location>
                </locations>
            </startingPosition>
            <hooks/>
        </item>
        <item name="старая шахтёрская кирка" id="КиркаПред">
            <attributes/>
            <description>Старая, но ещё крепкая шахтёрская кирка.</description>
            <words mainWord="кирка">
                <word>кирка</word>
            </words>
            <startingPosition>
                <inventory>false</inventory>
                <locations>
                    <location>СтараяШахта</location>
                </locations>
            </startingPosition>
            <hooks/>
        </item>
        <item name="динамит" id="ДинамитПред">
            <attributes/>
            <description>Небольшая связка динамита с коротким шнуром. Таким опасно пользоваться!</description>
            <words mainWord="динамит">
                <word>динамит</word>
            </words>
            <startingPosition>
                <inventory>false</inventory>
                <locations>
                    <location>Штольня</location>
                </locations>
            </startingPosition>
            <hooks/>
        </item>
        <item name="cтвол засохшей лианы" id="CтволЗасохшейЛианы">
            <attributes>
                <attribute>частьПейзажа</attribute>
                <attribute>прикреплён</attribute>
            </attributes>
            <description>Старая засохшая лиана растёт из земли.</description>
            <words mainWord="лиана">
                <word>лиана</word>
            </words>
            <startingPosition>
                <inventory>false</inventory>
                <locations>
                    <location>Растительность</location>
                </locations>
            </startingPosition>
            <hooks>
                <hook action="срубить" type="instead" objectElement="что">
                    <instructions>
                        <if position="1" condition="СрубилЛиану">
                            <then>
                                <showMessage position="1" type="text" message="Вы уже срубили лиану."/>
                            </then>
                            <else>
                                <if position="2" condition="чем = КиркаПред">
                                    <then>
                                        <showMessage position="1" type="text" message="Вы срубили одну лиану киркой!"/>
                                        <moveItem position="2" item="CтволЗасохшейЛианы" to="инвентарий"/>
                                        <!--<getItem position="2" item="CтволЗасохшейЛианы"/>-->
                                        <var position="3" name="СрубилЛиану" value="да"/>
                                    </then>
                                    <else>
                                        <showMessage position="1" type="expression" beginWithCap="true"
                                                     message="глагол + ' лиану ' + чем.тп + ' не получилось.'"/>
                                    </else>
                                </if>
                            </else>
                        </if>
                    </instructions>
                </hook>
                <hook action="осмотреть" objectElement="предмет" type="instead">
                    <instructions>
                        <if position="1" condition="СрубилЛиану">
                            <then>
                                <showMessage position="1" type="text" message="Твёрдая сухая лиана."/>
                            </then>
                            <else>
                                <showMessage position="1" type="expression" message="предмет.описание"/>
                            </else>
                        </if>
                    </instructions>
                </hook>
                <hook action="взять" objectElement="предмет" type="instead">
                    <instructions>
                        <if position="1" condition="СрубилЛиану">
                            <then>
                                <showMessage position="1" type="text" message="Вы уже срубили и взяли лиану."/>
                            </then>
                            <else>
                                <showMessage position="1" type="text" message="Вы попытались выдернуть лиану голыми руками, но ничего не вышло."/>
                            </else>
                        </if>
                    </instructions>
                </hook>
            </hooks>
        </item>
    </items>
    <actions>
        <action name="срубить" description="срубить|срезать [что] [чем]">
            <templates>
                <template>
                    <literalElement position="1" parameter="глагол">
                        <synonym>срубить</synonym>
                        <synonym>срезать</synonym>
                    </literalElement>
                    <objectElement position="2" case="vp" parameter="что"/>
                    <objectElement position="3" case="tp" parameter="чем"/>
                </template>
                <template>
                    <literalElement position="1" parameter="глагол">
                        <synonym>срубить</synonym>
                        <synonym>срезать</synonym>
                    </literalElement>
                    <objectElement position="2" case="tp" parameter="чем"/>
                    <objectElement position="3" case="vp" parameter="что"/>
                </template>
            </templates>
            <restrictions>
                <restriction condition="не что.прикреплён">
                    <reaction>
                        <showMessage position="1" type="expression" message="'Разве ' + что + ' к чему-то прикреплен(а), чтобы ' + глагол + '?'"/>
                    </reaction>
                </restriction>
            </restrictions>
            <procedureCall procedure="срубить"/>
        </action>

        <action name="отл">
            <templates>
                <template>
                    <literalElement position="1" parameter="ком">
                        <synonym>го</synonym>
                    </literalElement>
                </template>
            </templates>
            <procedureCall procedure="отл"/>
        </action>
    </actions>
    <procedures>
        <procedure name="ПоказатьПредысторию">
            <parameters/>
            <procedureVariables/>
            <procedureBody>
                <showMessage message="Вы - спелеолог, и Вы отправились в экспедицию в пещеру. Когда Вы отошли достаточно далеко, то услышали шум: выход завалило камнями!" carriageReturn="true" beginWithCap="false" type="text" position="1"/>
                <showMessage message="Упоминайте предметы одним основным словом." carriageReturn="true" beginWithCap="false" type="text" position="2"/>
            </procedureBody>
        </procedure>

        <procedure name="срубить">
            <parameters>
                <parameter name="глагол"/>
                <parameter name="что"/>
                <parameter name="чем"/>
            </parameters>
            <procedureBody>
                <showMessage position="1" type="expression" message="'Я не знаю, как ' + глагол + ' ' + что.вп + ' ' + чем.тп + '.'"/>
            </procedureBody>
        </procedure>

        <procedure name="отл">
            <procedureBody>
                <if position="1" condition="ком = 'го'">
                    <then>
                        <goToLoc position="1" location="Растительность"/>
                        <moveItem position="2" item="КиркаПред" to="инвентарий"/>
                        <!--<getItem position="2" item="КиркаПред"/>-->
                    </then>
                    <else>
                        <showMessage position="1" type="text" message="Не знаю такой отладочной команды."/>
                    </else>
                </if>
            </procedureBody>
        </procedure>
    </procedures>
</story>
